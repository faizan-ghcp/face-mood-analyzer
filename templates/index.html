<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Face Mood Analyzer</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Redirect to login if no JWT
    if (!localStorage.getItem('jwt')) {
      window.location.href = '/login';
    }
  </script>
</head>
<body>

  <div class="container">
    <button id="logoutBtn" style="float:right;">Logout</button>
    <h1>Face Mood Analyzer</h1>

    <div id="consentStep" style="margin-bottom:24px;">
      <button id="consentBtn" style="margin-right:12px;">Give consent for data storing</button>
      <button id="noConsentBtn">Continue without saving data</button>
    </div>

    <div id="saveStep" style="margin-bottom:18px; display:none;">
  <label><input type="checkbox" id="saveCheckbox" checked /> Save this scan to history</label>
  <button id="saveNextBtn" style="margin-left:12px;">Next</button>
    </div>

    <div class="palette-bar">
      <label for="paletteSelect">Theme:</label>
      <select id="paletteSelect">
        <option value="default">Default</option>
        <option value="sunset">Sunset</option>
        <option value="mint">Mint</option>
        <option value="ocean">Ocean</option>
        <option value="pastel">Pastel</option>
      </select>
    </div>

    <div class="top-links">
      <a href="/history">View Mood History</a>
    </div>

    <!-- Only keep the decorated question card below -->
      <div id="questionCard" style="margin-bottom:32px; display:block; background: var(--card); border-radius: 18px; box-shadow: 0 4px 24px #4f8cff22; padding: 32px 28px; max-width: 520px; margin-left:auto; margin-right:auto;">
        <div id="questionProgress" style="margin-bottom:18px; text-align:right; font-size:1em; color:var(--accent); font-weight:500;"></div>
        <div id="questionText" style="font-size:1.35em; margin-bottom:18px; font-weight:600; color:var(--accent);"></div>
        <div id="optionButtons" style="display:flex; flex-wrap:wrap; gap:16px; justify-content:center; margin-bottom:10px;"></div>
        <button id="nextQuestionBtn" style="display:none; margin-top:22px; background:var(--accent); color:#fff; font-weight:500; border-radius:8px; padding:10px 24px; box-shadow:0 2px 8px #4f8cff22;">Next</button>
      </div>

    <div id="camera" style="display:none;">
      <video id="video" width="480" height="360" autoplay muted></video>
      <button id="captureBtn">Scan Mood</button>
      <div id="scanProgress" style="display:none; margin-top:10px;">
        <div style="height:18px; background:#eee; border-radius:8px; overflow:hidden;">
          <div id="progressBar" style="height:18px; width:0; background:var(--accent); transition:width 0.3s;"></div>
        </div>
        <div id="progressText" style="margin-top:4px; font-size:13px; color:var(--fg);">Scanning...</div>
      </div>
    </div>

    <div id="scanSummary" style="display:none; margin-top:18px;">
      <h2>1-Minute Mood Summary</h2>
      <div id="summaryText"></div>
      <canvas id="summaryChart" width="480" height="300"></canvas>
      <div id="noteSection" style="margin-top:16px;">
        <label for="noteInput"><b>Add a note (optional):</b></label><br>
        <textarea id="noteInput" rows="3" style="width:100%;max-width:480px;"></textarea><br>
        <button id="saveNoteBtn" style="margin-top:8px;">Save Note</button>
        <span id="noteStatus" style="margin-left:10px;color:green;"></span>
      </div>
      <button id="closeSummaryBtn">Close Summary</button>
    </div>

    <div id="result" style="display:none;">
      <h2>Detected: <span id="dominant"></span> (<span id="intensity"></span>%)</h2>
      <canvas id="emotionChart" width="480" height="300"></canvas>
      <h3>Suggestions</h3>
      <ul id="tips"></ul>
      <button id="rescanBtn">Scan Again</button>
    </div>

    <canvas id="hiddenCanvas" style="display:none;"></canvas>
  </div>

<script src="/static/js/app.js"></script>
<script>
document.getElementById('logoutBtn').onclick = function() {
  localStorage.removeItem('jwt');
  window.location.href = '/login';
};
// Question card logic
let questions = [];
let currentQuestion = 0;
let answers = [];

// Consent logic
window.addEventListener('DOMContentLoaded', () => {
  const consentStep = document.getElementById('consentStep');
  const saveStep = document.getElementById('saveStep');
  const questionCard = document.getElementById('questionCard');
  const consentBtn = document.getElementById('consentBtn');
  const noConsentBtn = document.getElementById('noConsentBtn');
  const saveNextBtn = document.getElementById('saveNextBtn');
  const saveCheckbox = document.getElementById('saveCheckbox');

  // Hide all except consent step at start
  consentStep.style.display = '';
  saveStep.style.display = 'none';
  questionCard.style.display = 'none';

  consentBtn.onclick = () => {
    consentStep.style.display = 'none';
    saveStep.style.display = '';
    questionCard.style.display = 'none';
  };

  noConsentBtn.onclick = () => {
    consentStep.style.display = 'none';
    saveStep.style.display = 'none';
    questionCard.style.display = '';
    loadQuestions();
  };

  saveNextBtn.onclick = () => {
  // Get username from JWT
  let jwt = localStorage.getItem('jwt');
  let username = null;
  if (jwt) {
    try {
      const payload = JSON.parse(atob(jwt.split('.')[1]));
      username = payload.username;
    } catch {}
  }
  consentName = saveCheckbox.checked ? username : null;
  saveStep.style.display = 'none';
  questionCard.style.display = '';
  loadQuestions();
  };
});

async function loadQuestions() {
  const res = await fetch('/static/data/questions.json');
  questions = (await res.json()).preAnalysisQuestions || [];
  showQuestion(0);
}

function showQuestion(idx) {
  const card = document.getElementById('questionCard');
  const qText = document.getElementById('questionText');
  const optBtns = document.getElementById('optionButtons');
  const nextBtn = document.getElementById('nextQuestionBtn');
  if (idx >= questions.length) {
    card.style.display = 'none';
    document.getElementById('camera').style.display = '';
    if (window.startCamera) window.startCamera();
    return;
  }
  const q = questions[idx];
  qText.textContent = q.question;
  optBtns.innerHTML = '';
  nextBtn.style.display = 'none';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.style.background = q.colors[i] || '#eee';
    btn.style.color = '#222';
    btn.style.margin = '6px';
    btn.style.padding = '10px 18px';
    btn.style.border = 'none';
    btn.style.borderRadius = '8px';
    btn.style.cursor = 'pointer';
    btn.onclick = () => {
      answers[idx] = opt;
      Array.from(optBtns.children).forEach(b => b.disabled = false);
      btn.disabled = true;
      // Go to next question after 1 second
      setTimeout(() => {
        showQuestion(++currentQuestion);
      }, 1000);
    };
    optBtns.appendChild(btn);
  });
};
</script>
</body>
</html>
