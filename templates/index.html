<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Face Mood Analyzer</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div class="container">
    <h1>Face Mood Analyzer</h1>

    <div id="consentStep" style="margin-bottom:24px;">
      <button id="consentBtn" style="margin-right:12px;">Give consent for data storing</button>
      <button id="noConsentBtn">Continue without saving data</button>
    </div>

    <div id="saveStep" style="margin-bottom:18px; display:none;">
      <label><input type="checkbox" id="saveCheckbox" checked /> Save this scan to history</label>
      <input id="nameInput" placeholder="Enter your name" />
      <button id="saveNextBtn" style="margin-left:12px;">Next</button>
    </div>

    <div class="palette-bar">
      <label for="paletteSelect">Theme:</label>
      <select id="paletteSelect">
        <option value="default">Default</option>
        <option value="sunset">Sunset</option>
        <option value="mint">Mint</option>
        <option value="ocean">Ocean</option>
        <option value="pastel">Pastel</option>
      </select>
    </div>

    <div class="top-links">
      <a href="/history">View Mood History</a>
    </div>

    <div id="questionCard" style="margin-bottom:24px; display:block;">
      <div id="questionText" style="font-size:1.2em; margin-bottom:16px;"></div>
      <div id="optionButtons"></div>
      <button id="nextQuestionBtn" style="display:none; margin-top:16px;">Next</button>
    </div>

    <div id="camera" style="display:none;">
      <video id="video" width="480" height="360" autoplay muted></video>
      <button id="captureBtn">Scan Mood</button>
      <div id="scanProgress" style="display:none; margin-top:10px;">
        <div style="height:18px; background:#eee; border-radius:8px; overflow:hidden;">
          <div id="progressBar" style="height:18px; width:0; background:var(--accent); transition:width 0.3s;"></div>
        </div>
        <div id="progressText" style="margin-top:4px; font-size:13px; color:var(--fg);">Scanning...</div>
      </div>
    </div>

    <div id="scanSummary" style="display:none; margin-top:18px;">
      <h2>1-Minute Mood Summary</h2>
      <div id="summaryText"></div>
      <canvas id="summaryChart" width="480" height="300"></canvas>
      <button id="closeSummaryBtn">Close Summary</button>
    </div>

    <div id="result" style="display:none;">
      <h2>Detected: <span id="dominant"></span> (<span id="intensity"></span>%)</h2>
      <canvas id="emotionChart" width="480" height="300"></canvas>
      <h3>Suggestions</h3>
      <ul id="tips"></ul>
      <button id="rescanBtn">Scan Again</button>
    </div>

    <canvas id="hiddenCanvas" style="display:none;"></canvas>
  </div>

<script src="/static/js/app.js"></script>
<script>
// Question card logic
let questions = [];
let currentQuestion = 0;
let answers = [];

// Consent logic
window.addEventListener('DOMContentLoaded', () => {
  const consentStep = document.getElementById('consentStep');
  const saveStep = document.getElementById('saveStep');
  const questionCard = document.getElementById('questionCard');
  const consentBtn = document.getElementById('consentBtn');
  const noConsentBtn = document.getElementById('noConsentBtn');
  const saveNextBtn = document.getElementById('saveNextBtn');
  const saveCheckbox = document.getElementById('saveCheckbox');
  const nameInput = document.getElementById('nameInput');

  // Hide all except consent step at start
  consentStep.style.display = '';
  saveStep.style.display = 'none';
  questionCard.style.display = 'none';

  consentBtn.onclick = () => {
    consentStep.style.display = 'none';
    saveStep.style.display = '';
    questionCard.style.display = 'none';
    nameInput.disabled = !saveCheckbox.checked;
    saveCheckbox.addEventListener('change', () => {
      nameInput.disabled = !saveCheckbox.checked;
      if (!saveCheckbox.checked) {
        nameInput.value = '';
      }
    });
  };

  noConsentBtn.onclick = () => {
    consentStep.style.display = 'none';
    saveStep.style.display = 'none';
    questionCard.style.display = '';
    loadQuestions();
  };

  saveNextBtn.onclick = () => {
  consentName = saveCheckbox.checked ? nameInput.value : null;
  saveStep.style.display = 'none';
  questionCard.style.display = '';
  loadQuestions();
  };
});

async function loadQuestions() {
  const res = await fetch('/static/data/questions.json');
  questions = (await res.json()).preAnalysisQuestions || [];
  showQuestion(0);
}

function showQuestion(idx) {
  const card = document.getElementById('questionCard');
  const qText = document.getElementById('questionText');
  const optBtns = document.getElementById('optionButtons');
  const nextBtn = document.getElementById('nextQuestionBtn');
  if (idx >= questions.length) {
    card.style.display = 'none';
    document.getElementById('camera').style.display = '';
    if (window.startCamera) window.startCamera();
    return;
  }
  const q = questions[idx];
  qText.textContent = q.question;
  optBtns.innerHTML = '';
  nextBtn.style.display = 'none';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.style.background = q.colors[i] || '#eee';
    btn.style.color = '#222';
    btn.style.margin = '6px';
    btn.style.padding = '10px 18px';
    btn.style.border = 'none';
    btn.style.borderRadius = '8px';
    btn.style.cursor = 'pointer';
    btn.onclick = () => {
      answers[idx] = opt;
      Array.from(optBtns.children).forEach(b => b.disabled = false);
      btn.disabled = true;
      // Go to next question after 1 second
      setTimeout(() => {
        showQuestion(++currentQuestion);
      }, 1000);
    };
    optBtns.appendChild(btn);
  });
};
</script>
</body>
</html>
